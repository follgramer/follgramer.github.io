<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Hijos de Dios</title>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; border-bottom: 3px solid #FF0000; padding-bottom: 10px; }
        
        .card { 
            background: white; 
            padding: 20px; 
            margin-bottom: 15px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            border-left: 10px solid #ffa500;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .card.approved { 
            border-left: 10px solid #28a745; 
            background-color: #f0fff4; 
        }

        .info { flex: 1; min-width: 250px; }
        .info p { margin: 5px 0; }
        
        .proof-img { 
            width: 120px; 
            height: 120px; 
            object-fit: cover; 
            border-radius: 5px; 
            border: 2px solid #ddd; 
            cursor: pointer; 
        }
        .proof-img:hover { border-color: #FF0000; }

        .actions { min-width: 250px; text-align: right; }

        button { 
            padding: 12px 25px; 
            background: #28a745; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: transform 0.2s;
            margin: 5px 0;
            width: 100%;
        }
        button:hover { transform: scale(1.05); background: #218838; }
        button:active { transform: scale(0.95); }

        .btn-copy { background: #007bff; }
        .btn-copy:hover { background: #0056b3; }

        .btn-whatsapp { background: #25D366; }
        .btn-whatsapp:hover { background: #1da851; }

        .badge { 
            background: #ffa500; 
            color: white; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
        }
        .approved .badge { background: #28a745; }

        .token-box {
            background: #f8f9fa;
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>üëÆ‚Äç‚ôÇÔ∏è Panel de Control (Admin)</h1>
            <div id="statusIndicator" style="color: red; font-weight: bold;">üî¥ Desconectado</div>
        </div>
        
        <div id="orders-container">
            <p>Cargando pedidos...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCfhbsjmjmc63EmssjZLuMH0Lve9Vv9ksw",
            authDomain: "admin-c6497.firebaseapp.com",
            databaseURL: "https://admin-c6497-default-rtdb.firebaseio.com",
            projectId: "admin-c6497",
            storageBucket: "admin-c6497.firebasestorage.app",
            messagingSenderId: "829425376171",
            appId: "1:829425376171:web:87c62090a163de9c3910ee"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase iniciado correctamente");
            document.getElementById('statusIndicator').innerHTML = "üü¢ CONECTADO";
            document.getElementById('statusIndicator').style.color = "green";
        } catch (e) {
            alert("Error iniciando Firebase: " + e.message);
        }

        const db = firebase.database();
        const ordersRef = db.ref('pedidos');

        // Funci√≥n para generar token √∫nico
        function generateToken() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Leer pedidos en tiempo real
        ordersRef.on('value', (snapshot) => {
            const container = document.getElementById('orders-container');
            container.innerHTML = "";

            const data = snapshot.val();

            if (!data) {
                container.innerHTML = "<h3>No hay pedidos pendientes.</h3>";
                return;
            }

            const orders = Object.entries(data).reverse();

            orders.forEach(([key, order]) => {
                const isApproved = order.estado === 'aprobado';
                
                const card = document.createElement('div');
                card.className = `card ${isApproved ? 'approved' : ''}`;
                
                let actionsHTML = '';
                
                if (isApproved) {
                    // Si ya est√° aprobado, mostrar token y botones
                    const accessLink = order.url_pagina + '?access=' + order.token;
                    actionsHTML = `
                        <h3 style="color:green; margin:0;">‚úÖ APROBADO</h3>
                        <div class="token-box">
                            <strong>Token:</strong> ${order.token}<br>
                            <strong>Enlace:</strong> ${accessLink}
                        </div>
                        <button class="btn-copy" onclick="copyLink('${accessLink}')">
                            üìã COPIAR ENLACE
                        </button>
                        <button class="btn-whatsapp" onclick="sendWhatsApp('${order.whatsapp}', '${accessLink}', '${order.nombre}')">
                            üì± ENVIAR POR WHATSAPP
                        </button>
                    `;
                } else {
                    // Bot√≥n de aprobar
                    actionsHTML = `
                        <button onclick="approveOrder('${key}', '${order.url_pagina}')">
                            ‚úÖ APROBAR AHORA
                        </button>
                    `;
                }
                
                card.innerHTML = `
                    <div class="info">
                        <h3>${order.nombre} <span class="badge">${order.estado}</span></h3>
                        <p>üì± <strong>WhatsApp:</strong> <a href="https://wa.me/${order.whatsapp.replace(/\D/g,'')}" target="_blank">${order.whatsapp}</a></p>
                        <p>üìß <strong>Email:</strong> ${order.email || 'N/A'}</p>
                        <p>üìÖ <strong>Fecha:</strong> ${order.fecha || 'Reciente'}</p>
                        <p>üîó <a href="${order.url_pagina}" target="_blank" style="color:blue;">Ver p√°gina origen</a></p>
                    </div>

                    <div>
                        <a href="${order.foto_comprobante}" target="_blank">
                            <img src="${order.foto_comprobante}" class="proof-img" alt="Comprobante">
                        </a>
                        <div style="text-align:center; font-size:0.8rem; color:#666;">Clic para ver</div>
                    </div>

                    <div class="actions">
                        ${actionsHTML}
                    </div>
                `;
                container.appendChild(card);
            });
        }, (error) => {
            alert("Error leyendo base de datos: " + error.message);
        });

        // Funci√≥n de aprobaci√≥n con generaci√≥n de token
        function approveOrder(orderId, pageUrl) {
            if(confirm("¬øEst√°s seguro de APROBAR este pago?\n\nSe generar√° un token √∫nico y el usuario recibir√° acceso.")) {
                
                // Generar token √∫nico
                const token = generateToken();
                
                // Actualizar pedido con estado aprobado y token
                db.ref('pedidos/' + orderId).update({
                    estado: "aprobado",
                    token: token,
                    fecha_aprobacion: new Date().toLocaleString()
                })
                .then(() => {
                    // Guardar token en nodo separado para verificaci√≥n r√°pida
                    return db.ref('tokens/' + token).set({
                        pedido_id: orderId,
                        estado: 'aprobado',
                        fecha_creacion: new Date().toLocaleString()
                    });
                })
                .then(() => {
                    alert("‚úÖ ¬°LISTO! Pago aprobado correctamente.\n\nToken generado: " + token);
                })
                .catch((error) => {
                    alert("‚ùå ERROR: " + error.message + "\n\nRevisa las reglas de la base de datos.");
                });
            }
        }

        // Funci√≥n para copiar enlace
        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert("‚úÖ Enlace copiado al portapapeles:\n\n" + link);
            }).catch(() => {
                // Fallback para navegadores antiguos
                const textarea = document.createElement('textarea');
                textarea.value = link;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert("‚úÖ Enlace copiado al portapapeles:\n\n" + link);
            });
        }

        // Funci√≥n para enviar mensaje por WhatsApp
        function sendWhatsApp(phone, accessLink, name) {
            const mensaje = `¬°Hola ${name}! üëã

¬°Gracias por adquirir la Gu√≠a Premium de Monetizaci√≥n para YouTube! üéâ

Tu acceso ha sido confirmado. Aqu√≠ est√° tu enlace personal:

üîó ${accessLink}

üìå *IMPORTANTE - Lee esto antes de comenzar:*

Esta gu√≠a contiene estrategias probadas y efectivas basadas en casos reales de aprobaci√≥n de monetizaci√≥n. Sin embargo, es importante que sepas lo siguiente:

‚úÖ *La gu√≠a funciona SI*:
‚Ä¢ Sigues cada paso al detalle
‚Ä¢ Aplicas las estrategias con dedicaci√≥n
‚Ä¢ Eres constante en la implementaci√≥n
‚Ä¢ Adaptas el contenido a tu canal espec√≠fico

‚ö†Ô∏è *Ten en cuenta que*:
‚Ä¢ El √©xito depende en un 90% de tu esfuerzo y aplicaci√≥n correcta
‚Ä¢ Un 10% depende del criterio del revisor humano de YouTube
‚Ä¢ No existe una garant√≠a 100% ya que YouTube tiene la decisi√≥n final
‚Ä¢ Cada canal es √∫nico y puede requerir ajustes personalizados

üí™ *Mi compromiso contigo*:
Te he dado las mejores herramientas y estrategias que han funcionado. El resto depende de tu dedicaci√≥n y empe√±o en aplicarlas correctamente.

Si tienes dudas durante el proceso, no dudes en contactarme.

¬°√âxito con tu monetizaci√≥n! üöÄ

_Documento confidencial - Uso exclusivo_`;

            const encodedMessage = encodeURIComponent(mensaje);
            const whatsappUrl = `https://wa.me/${phone.replace(/\D/g,'')}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
        }

    </script>

</body>
</html>
